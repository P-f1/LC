"use strict";function buildSchema(e,t,n){return Observable_1.Observable.create(function(r){wi_contrib_1.WiContributionUtils.getConnections(e,"GraphBuilder_Tools").subscribe(function(e){var o;e.forEach(function(e){for(var n,r=0,i=e.settings;r<i.length;r++){var a=i[r];"name"===a.name?n=a.value:"schema"===a.name&&t===n&&(o=a.value)}}),console.log("*****************************************************"),console.log(n(o)),console.log("*****************************************************"),r.next(n(o)),r.complete()})})}function populateAttribute(e){switch(e){case"Double":case"Integer":case"Long":return 2;case"Boolean":return!0;case"Date":return 2;case"Object":return{};case"Array":return[];default:return"2"}}function combination(e,t,n,r,o,i,a){if(o!==i)for(var l=n;l<=r&&r-l+1>=i-o;)t[o]=e[l],combination(e,t,l+1,r,o+1,i,a),l+=1;else{for(var u="",c=0;c<i;c++)0!==c&&(u+=" "),u+=t[c];a.push(u)}}var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(o=e[l])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("rxjs/Observable"),core_1=require("@angular/core"),http_1=require("@angular/http"),wi_contrib_1=require("wi-studio/app/contrib/wi-contrib"),TableQueryContributionHandler=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.http=n,r.value=function(e,t){console.log("[TableQueryContributionHandler::value] fieldName = "+e);var n={};if("Table"===e){console.log("[TableQueryContributionHandler::value] in Table !!");for(var o=t.getField("Table").allowed,i=t.getField("Table").value,a=0,l=o;a<l.length;a++){var u=l[a];u.unique_id===i&&(r.selectedConnector=u.name)}return Observable_1.Observable.create(function(e){wi_contrib_1.WiContributionUtils.getConnections(r.http,"GraphBuilder_Tools").subscribe(function(t){var n=[];t.forEach(function(e){for(var t=0,r=e.settings;t<r.length;t++){var o=r[t];"name"===o.name&&n.push({unique_id:wi_contrib_1.WiContributionUtils.getUniqueId(e),name:o.value})}}),e.next(n),e.complete()})})}if("Indices"===e)return r.selectedIndices=t.getField("Indices").value,console.log("[TableQueryContributionHandler::value] in Indices !!"),buildSchema(r.http,r.selectedConnector,function(e){var t=[];if(e){for(var r=[],o=JSON.parse(e),i=0;i<o.length;i++)"yes"!==o[i].IsKey&&"yes"!==o[i].Indexed||r.push(o[i].Name),n[o[i].Name]=populateAttribute(o[i].Type);for(var a=[],l=1;l<r.length+1;l++)(o=[]).length=l,combination(r,o,0,r.length-1,0,l,a);for(var u=0;u<a.length;u++)t.push({unique_id:a[u],name:a[u]})}return t});if("QueryKey"===e){console.log("[TableQueryContributionHandler::value] in QueryKey !!");for(var c={},s=r.selectedIndices.split(" "),f=0;f<s.length;f++)c[s[f]]=populateAttribute(n[s[f]]);return JSON.stringify(c)}return"Data"===e?(console.log("[TableQueryContributionHandler::value] in Data !!"),buildSchema(r.http,r.selectedConnector,function(e){if(e){for(var t=[],n=JSON.parse(e),o=0;o<n.length;o++)"yes"===n[o].IsKey&&t.push(n[o].Name);var i="";for(o=0;o<t.length;o++)0!==o&&(i+=" "),i+=t[o];if(i==r.selectedIndices){var a={};for(o=0;o<n.length;o++)a[n[o].Name]=populateAttribute(n[o].Type);return JSON.stringify(a)}for(a=[{}],o=0;o<n.length;o++)a[0][n[o].Name]=populateAttribute(n[o].Type);return JSON.stringify(a)}return JSON.stringify({})})):null},r.validate=function(e,t){return console.log("[TableContributionHandler::validate] fieldName = "+e),null},r}return __extends(t,e),t=__decorate([wi_contrib_1.WiContrib({}),core_1.Injectable(),__param(0,core_1.Inject(core_1.Injector)),__metadata("design:paramtypes",[Object,http_1.Http])],t)}(wi_contrib_1.WiServiceHandlerContribution);exports.TableQueryContributionHandler=TableQueryContributionHandler;